{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "templatesBaseUri": {
      "type": "string"
    },
    "AccessToken": {
        "type": "string",
        "metadata": {
            "description": "Token that will acces the private repo from the logic app"
        }
    },
    "branch": {
        "type": "string",
        "defaultValue": "feature/DSI-6238",
        "metadata": {
            "description": "Branch that use for the ARM templateLinks"
        }
    },
    "appInsightsName": {
      "type": "string",
      "metadata": {
        "description": "Name of the application insights resource"
      }
    },
    "redisCacheName": {
      "type": "string"
    },
    "redisCacheSku": {
      "type": "object",
      "defaultValue": "",
      "metadata": {
        "description": ""
      }
    },
    "amplsName": {
      "type": "string"
    },
    "neuResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "The North Europe Recource Group Name"
      }
    },
    "sqlAdministratorLogin": {
      "type": "string",
      "metadata": {
        "description": "The admin user of the SQL Server"
      }
    },
    "sqlAdministratorLoginPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password of the admin user of the SQL Server"
      }
    },
    "sqlserverName": {
      "type": "string",
      "metadata": {
        "description": "The name of the SQL Server"
      }
    },
    "neuSqlServerName": {
      "type": "string",
      "metadata": {
        "description": "The name of the SQL Server in North Europe"
      }
    },
    "elasticPoolName": {
      "type": "string",
      "metadata": {
        "description": "The name of the SQL Elastic Pool"
      }
    },
    "databaseNames": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Azure DevOps variable format: [{\"name\":\"temp-signin-audit-db\",\"maxSizeBytes\":\"1073741824\"} N.B. use without backslash"
      }
    },
    "transparentDataEncryption": {
      "type": "string",
      "metadata": {
        "description": "Enable or disable Transparent Data Encryption (TDE) for the database."
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the storage account resource"
      }
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Key Vault resource"
      }
    },
    "keyVaultDigiPassName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Key Vault Devices resource for Digipass"
      }
    },
    "azureSearchName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Search resource"
      }
    },
    "azureDataFactoryName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Data Factory resource"
      }
    },
    "azureCdnName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Cdn Profile resource"
      }
    },
    "azureCdnSku": {
      "type": "string",
      "defaultValue": "Standard_Verizon",
      "allowedValues": [
        "Standard_Verizon",
        "Premium_Verizon"
      ]
    },
    "cdnEndpointName": {
      "type": "string"
    },
    "originName": {
      "defaultValue": "",
      "type": "string"
    },
    "originHostname": {
      "type": "string"
    },
    "customDomainName": {
      "defaultValue": "",
      "type": "string"
    },
    "CHGWIP": {
      "type": "string",
      "metadata": {
        "description": "GovWiFi | Purple | Guest"
      }
    },
    "keyvaultCertificateNames": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Names of the certificates stored in keyvault"
      }
    },
    "elasticPoolSku": {
      "type": "object",
      "metadata": {
        "description": "SKU for the elastic pool"
      }
    },
    "elasticPoolProperties": {
      "type": "object",
      "metadata": {
        "description": "Properties for the elastic pool"
      }
    },
    "aadshdclientid": {
      "type": "string",
      "metadata": {
        "description": "Object Id of the aad shd client id for Devices vault connection"
      }  
    },
    "azureDevOpsObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object Id of the Azure Websites RP",
        "environmentVariable": "azureDevOpsObjectId"
      }
    },
    "keyVaultApplicationObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object Id of the Key Vault application",
        "environmentVariable": "keyVaultApplicationObjectId"
      }
    },
    "destructiveVirtualNetworkDeploy": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "Enabled"
      ],
      "metadata": {
        "description": "Deploys the Virtual Network and deletes all subnets if Enabled https://github.com/Azure/azure-quickstart-templates/issues/2786",
        "environmentVariable": "destructiveVirtualNetworkDeploy"
      }
    },
    "applicationSubnets": {
      "type": "array",
      "defaultValue": [
        "samltier-g1-sn",
        "samltier-g2-sn",
        "prestier-g1-sn",
        "prestier-g2-sn",
        "prestier-g3-sn",
        "prestier-g4-sn",
        "prestier-g5-sn",
        "midtier-g1-sn",
        "midtier-g2-sn",
        "midtier-g3-sn",
        "backend-g1-sn",
        "backend-g2-sn",
        "backend-g3-sn",
        "utils-sn"
      ],
      "metadata": {
        "description": "Names of additional subnets to create for application integration"
      }
    },
     "pireanSubnets": {
      "type": "array",
      "defaultValue": [
        "pmppsyncfa-sn",
        "pmppsyncst-sn",
        "pmpporgssyncfa-sn",
        "pmpporgssyncst-sn",
        "pmppprodeltafa-sn",
        "pmppprodeltast-sn"
      ],
      "metadata": {
        "description": "Names of pirean subnets to create for service bus integration"
      }
    },
    "TopicNames": {
      "type": "array",
      "defaultValue": [
        {
          "name": "audit",
          "subscription":"audit-messages",
          "secretNameTopic": "auditServiceBusTopicName",
          "secretNameSubscription": "auditServiceBusSubscriptionName"
        },
        {
          "name": "securealert",
          "subscription":"securealert-messages",
          "secretNameTopic": "secureServiceBusTopicName",
          "secretNameSubscription": "secureServiceBusSubscriptionName"
        }
        
      ],
      "metadata": {
        "description": "Topic names & subscriptions of service bus"
      }
    },
    "platformGlobalIdentifier": {
      "type": "string",
      "defaultValue": "s141"
    },
    "environmentId": {
      "type": "string",
      "allowedValues": [
        "d01",
        "d03",
        "t01",
        "t02",
        "t03",
        "p01",
        "p02"
      ]
    },
    "platformGlobalName": {
      "type": "string",
      "defaultValue": "signin"
    },
    "infrastructureName": {
      "type": "string",
      "defaultValue": "shd"
    },
    "serviceEndpointList": {
      "type": "array",
      "defaultValue": [
        "Microsoft.Web",
        "Microsoft.Sql",
        "Microsoft.Storage",
        "Microsoft.KeyVault",
        "Microsoft.ServiceBus"
      ],
      "allowedValues": [
        "Microsoft.Web",
        "Microsoft.Sql",
        "Microsoft.Storage",
        "Microsoft.KeyVault",
        "Microsoft.ServiceBus"
      ]
    },
    "serviceBusSku": {
      "type": "string",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ],
      "defaultValue": "Premium",
      "metadata": {
        "description": "The messaging tier for service Bus namespace"
      }
    },
    "deployRedisCachePrivateEndpoint": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy a private endpoint to the Redis Cache instance"
      }
    },
    "deployAzureSearch": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy the Azure Search instance"
      }
    },
    "deployAzureSearchPrivateEndpoint": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy a private endpoint to the Azure Search instance"
      }
    },
    "deployamplsPrivateEndpoint": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy a Azure Monitor private link scope"
      }
    },
    "provisionSQLGeoReplication": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to provision SQL Server Geo Replication"
      }
    },
    "deployDataFactory": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to deploy Data Factory"
      }
    },
    "deployServiceBus": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy the shared Service Bus resource"
      }
    },
    "deployVirtualNetwork": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy the virtual network template which includes the defined subnets"
      }
    },
    "sqlFirewallRulesCopyMode": {
      "type": "string",
      "defaultValue": "Parallel",
      "allowedValues": [
        "Parallel",
        "Serial"
      ],
      "metadata": {
        "description": "Mode to use in the SQL firewall rule copy function. Using Serial for the initial deployment can help eliminate conflicts."
      }
    },
    "cdnIpRules": {
        "type": "array"
    },
    "LogicAppConnectionIpRulesServiceBus": {
        "type": "array",
        "defaultValue": [
          "52.174.88.118",
          "40.91.208.65",
          "13.69.64.208/28",
          "13.69.71.192/27",
          "13.93.36.78",
          "20.86.93.32/27",
          "20.86.93.64/28",
          "20.126.243.151",
          "20.126.241.238",
          "20.103.132.139",
          "20.103.131.1"
        ]
    },
    "LogicAppConnectionIpRulesSql": {
        "type": "array",
        "defaultValue": [
          "52.174.88.118",
          "40.91.208.65",
          "13.69.64.208-13.69.64.223",
          "13.69.71.192-13.69.71.223",
          "13.93.36.78",
          "20.86.93.32-20.86.93.63",
          "20.86.93.64-20.86.93.79",
          "20.126.243.151",
          "20.126.241.238",
          "20.103.132.139",
          "20.103.131.1"
        ]
    },
    "azureActiveDirectoryAdmin": {
      "type": "string",
      "metadata": {
        "description": "Azure Active Directory admin"
      }
    },
    "azureActiveDirectoryAdminSID": {
      "type": "string",
      "metadata": {
        "description": "Azure Active Directory admin SID"
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "Virtual Network Name"
      }
    },
    "serviceBusNamespaceName": {
      "type": "string",
      "metadata": {
        "description": "Service Bus Name"
      }
    },
    "samltierAppServicePlanSku": {
      "type": "array",
      "defaultValue": [
        {
          "name": "samltier-g1-asp",
          "sku": {
            "name": "P1v2",
            "tier": "PremiumV2",
            "size": "P1v2",
            "family": "Pv2",
            "capacity": 3
          }
        },
        {
          "name": "samltier-g2-asp",
          "sku": {
            "name": "P1v2",
            "tier": "PremiumV2",
            "size": "P1v2",
            "family": "Pv2",
            "capacity": 3
          }
        }
      ],
      "metadata": {
        "description": "The SKU of the saml tier App Service Plan. Add another plan by copying the existing JSON and incrementing the id field by 1"
      }
    },
    "prestierAppServicePlanSku": {
      "type": "array",
      "defaultValue": [
        {
          "name": "prestier-g1-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "prestier-g2-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "prestier-g3-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "prestier-g4-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "prestier-g5-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        }
      ],
      "metadata": {
        "description": "The SKU of the front-end tier App Service Plan. Add another plan by copying the existing JSON and incrementing the id field by 1"
      }
    },
    "midtierAppServicePlanSku": {
      "type": "array",
      "defaultValue": [
        {
          "name": "midtier-g1-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "midtier-g2-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "midtier-g3-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        }
      ],
      "metadata": {
        "description": "The SKU of the mid tier App Service Plan. Add another plan by copying the existing JSON and incrementing the id field by 1"
      }
    },
    "backEndAppServicePlanSku": {
      "type": "array",
      "defaultValue": [
        {
          "name": "backend-g1-asp",
          "sku": {
            "name": "P2v2",
            "tier": "PremiumV2",
            "size": "P2v2",
            "family": "Pv3",
            "capacity": 3
          }
        },
        {
          "name": "backend-g2-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        }
      ],
      "metadata": {
        "description": "The SKU of the back-end tier App Service Plan. Add another plan by copying the existing JSON and incrementing the id field by 1"
      }
    },
    "utilsAppServicePlanSku": {
      "type": "array",
      "defaultValue": [
        {
          "name": "utils-asp",
          "sku": {
            "name": "S1",
            "tier": "PremiumV2",
            "size": "S1",
            "family": "",
            "capacity": 3
          }
        }
      ],
      "metadata": {
        "description": "The SKU of the utils tier App Service Plan. Add another plan by copying the existing JSON and incrementing the id field by 1"
      }
    },
    "pireanAppServicePlanSku": {
      "type": "array",
      "defaultValue": [
        {
          "name": "backend-g3-asp",
          "sku": {
            "name": "P1v3",
            "tier": "PremiumV2",
            "size": "P1v3",
            "family": "Pv3",
            "capacity": 3
          }
        }
      ],
      "metadata": {
        "description": "The SKU of the pirean tier App Service Plan. Add another plan by copying the existing JSON and incrementing the id field by 1"
      }
    },
    "deployASP": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy the Application Service Plans"
      }
    },
    "sqlFireWallRules": {
      "type": "array",
      "defaultValue": [
        {
          "Name": "DfE-London-Peering",
          "DisplayName": "DfE-(London Peering)",
          "IPRange": "104.209.113.99-104.209.113.99"
        },
        {
          "Name": "DfE-London-VPN",
          "DisplayName": "DfE-(London VPN)",
          "IPRange": "217.38.175.55-217.38.175.58"
        },
        {
          "Name": "DfE-Palo-Alto-VPN",
          "DisplayName": "DfE-(Palo Alto VPN)",
          "IPRange": "208.127.46.232-208.127.46.255"
        }
      ],
      "metadata": {
        "description": "White listed SQL Server Firewall rules"
      }
    }
  },
  "variables": {
    "serviceBusApiVersion": "2017-04-01",
    "redisSubnetName": "redis-sn-1",
    "azureSearchSubnetName": "azureSearch-sn-1",
    "workspaceId": "[tolower(concat(parameters('platformGlobalIdentifier'), parameters('environmentId'), '-', parameters('platformGlobalName'),'-shd-laws'))]",
    "amplsSubnetName": "ampls-sn-1",
    "elasticSku": {
      "name": "ElasticPool",
      "tier": "Standard"
    },
    "emptyArray": [],
    "redisCachePrivateEndpoint": {
      "privateDnsZoneName": "privatelink.redis.cache.windows.net",
      "virtualNetworkId": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
      "privateEndpointName": "[concat(parameters('redisCacheName'),'-', variables('redisSubnetName'), '-pe')]",
      "privateLinkResource": "[resourceId('Microsoft.Cache/Redis', parameters('redisCacheName'))]",
      "privateEndpointSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), variables('redisSubnetName'))]"
    },
    "azureSearchPrivateEndpoint": {
      "privateDnsZoneName": "privatelink.search.windows.net",
      "virtualNetworkId": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
      "privateEndpointName": "[concat(parameters('azureSearchName'),'-', variables('azureSearchSubnetName'), '-pe')]",
      "privateLinkResource": "[resourceId('Microsoft.Search/searchServices', parameters('azureSearchName'))]",
      "privateEndpointSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), variables('azureSearchSubnetName'))]"
    },
    "azureMonitorPrivateEndpoint": {
      "amplsPrivateDNSZoneName": "[concat(parameters('amplsName'), '-Private-DNS-Zone')]",
      "amplsAgentsvcPrivateDnsZoneName": "privatelink.agentsvc.azure-automation.net",
      "amplsBlobPrivateDnsZoneName": "privatelink.blob.core.windows.net",
      "amplsMonitorPrivateDnsZoneName": "privatelink.monitor.azure.com",
      "amplsOPInsightODSPrivateDnsZoneName": "privatelink.ods.opinsights.azure.com",
      "amplsOPInsightOMSPrivateDnsZoneName": "privatelink.oms.opinsights.azure.com",
      "amplsVirtualNetworkId": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
      "amplsVirtualNetworkName": "[parameters('virtualNetworkName')]",
      "amplsPrivateEndpointName": "[concat(parameters('amplsName'), '-pe')]",
      "amplsPrivateLinkResource": "[resourceId('Microsoft.insights/privateLinkScopes', parameters('amplsName'))]",
      "amplsPrivateEndpointSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), variables('amplsSubnetName'))]"
    },
    
    "keyVaultAccessPolicies": [
      {
        "objectId": "[parameters('aadshdclientid')]",
        "tenantId": "[subscription().tenantId]",
        "permissions": {
          "secrets": [
            "Get",
            "List",
            "Set",
            "Delete",
            "Recover",
            "Backup",
            "Restore"
          ]
        }
      }
    ],
    "copy": [{
      "name": "virtualNetworksSubNet",
      "count": "[length(parameters('applicationSubnets'))]",
      "input": {
        "id": "[resourceId(concat('s141',parameters('environmentId'),'-shd'), 'Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('applicationSubnets')[copyIndex('virtualNetworksSubNet')])]",
        "action": "Allow",
        "state": "Succeeded"
      }
    },
    { 
      "name": "pireanVnetSubnets",
       "count": "[length(parameters('pireanSubnets'))]",
       "input": "[resourceId(concat('s141',parameters('environmentId'),'-shd'), 'Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('pireanSubnets')[copyIndex('pireanVnetSubnets')])]" 
    },
    { 
      "name": "listOfDatabaseNames",
       "count": "[length(parameters('databaseNames'))]",
       "input": "[concat(resourceGroup().id, '/providers/Microsoft.Sql/servers/', parameters('sqlServerName'), '/databases/', parameters('databaseNames')[copyIndex('listOfDatabaseNames')].name)]"
 
    }
       

    ]
    
  },
  "resources": [
    {
      "apiVersion": "2022-05-01",
      "name": "azure-managed-grafana",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-managed-grafana.json')]"
        },
        "parameters": {
          "environmentId": {
            "value": "[parameters('environmentId')]"
          }
        }
      }
    },
    {
      "apiVersion": "2022-05-01",
      "name": "log-analytics-workspace",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/log-analytics-workspace.json')]"
        },
        "parameters": {
          "environmentId": {
            "value": "[parameters('environmentId')]"
          }
        }
      }
    },
    {
      "apiVersion": "2020-10-01",
      "name": "redis-cache",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/redis-cache.json')]"
        },
        "parameters": {
          "redisCacheName": {
            "value": "[parameters('redisCacheName')]"
          },
          "redisCacheSku": {
            "value": "[parameters('redisCacheSku')]"
          }
        }
      }
    },
    {
      "apiVersion": "2022-05-01",
      "name": "redis-cache-patch-schedule",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/redis-cache-patch-schedule.json')]"
        },
        "parameters": {
          "redisCacheName": {
            "value": "[parameters('redisCacheName')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'redis-cache')]"
      ]
    },
    {
      "condition": "[parameters('deployRedisCachePrivateEndpoint')]",
      "apiVersion": "2020-10-01",
      "name": "redis-cache-private-endpoint",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/redis-cache-private-endpoint.json')]"
        },
        "parameters": {
          "templatesBaseUri": {
            "value": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=')]"
          },
          "privateEndpointName": {
            "value": "[variables('redisCachePrivateEndpoint').privateEndpointName]"
          },
          "privateLinkResource": {
            "value": "[variables('redisCachePrivateEndpoint').privateLinkResource]"
          },
          "privateEndpointSubnetId": {
            "value": "[variables('redisCachePrivateEndpoint').privateEndpointSubnetId]"
          },
          "privateDnsZoneName": {
            "value": "[variables('redisCachePrivateEndpoint').privateDnsZoneName]"
          },
          "virtualNetworkId": {
            "value": "[variables('redisCachePrivateEndpoint').virtualNetworkId]"
          },
          "redisCacheName": {
            "value": "[parameters('redisCacheName')]"
          },
          "redisCacheSku": {
            "value": "[parameters('redisCacheSku')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'redis-cache')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtual-network')]"
      ]
    },
    {
      "condition": "[parameters('deployamplsPrivateEndpoint')]",
      "apiVersion": "2020-10-01",
      "name": "ampls",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/ampls.json')]"
        },
        "parameters": {
          "amplsName": {
            "value": "[parameters('amplsName')]"
          },
          "appInsightsName": {
            "value": "[parameters('appInsightsName')]"
          },
          "amplsPrivateEndpointName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsprivateEndpointName]"
          },
          "amplsPrivateLinkResource": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsprivateLinkResource]"
          },
          "amplsPrivateDnsZoneName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsprivateDnsZoneName]"
          },
          "amplsAgentsvcPrivateDnsZoneName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsAgentsvcPrivateDnsZoneName]"
          },
          "amplsBlobPrivateDnsZoneName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsBlobPrivateDnsZoneName]"
          },
          "amplsMonitorPrivateDnsZoneName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsMonitorPrivateDnsZoneName]"
          },
          "amplsOPInsightODSPrivateDnsZoneName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsOPInsightODSPrivateDnsZoneName]"
          }, 
          "amplsOPInsightOMSPrivateDnsZoneName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsOPInsightOMSPrivateDnsZoneName]"
          },
          "amplsPrivateEndpointSubnetId": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsprivateEndpointSubnetId]"
          },
          "amplsVirtualNetworkId": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsvirtualNetworkId]"
          },
          "amplsVirtualNetworkName": {
            "value": "[variables('azureMonitorPrivateEndpoint').amplsVirtualNetworkName]"
          }
        },
        "dependsOn": [
          "[resourceId('Microsoft.Resources/deployments', 'virtual-network')]",
          "[resourceId('Microsoft.Resources/deployments', 'app-insights')]"
        ]
      }
    },
    {
      "name": "sql-server",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-sql.json')]"
        },
        "parameters": {
          "sqlAdministratorLogin": {
            "value": "[parameters('sqlAdministratorLogin')]"
          },
          "sqlAdministratorLoginPassword": {
            "value": "[parameters('sqlAdministratorLoginPassword')]"
          },
          "sqlserverName": {
            "value": "[parameters('sqlserverName')]"
          },
          "elasticPoolName": {
            "value": "[parameters('elasticPoolName')]"
          },
          "CHGWIP": {
            "value": "[parameters('CHGWIP')]"
          },
          "elasticPoolSku": {
            "value": "[parameters('elasticPoolSku')]"
          },
          "elasticPoolProperties": {
            "value": "[parameters('elasticPoolProperties')]"
          },
          "azureActiveDirectoryAdmin": {
            "value": "[parameters('azureActiveDirectoryAdmin')]"
          },
          "azureActiveDirectoryAdminSID": {
            "value": "[parameters('azureActiveDirectoryAdminSID')]"
          }
        }
      }
    },
    {
      "condition": "[parameters('provisionSQLGeoReplication')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "neu-Resources-deployment",
      "resourceGroup": "[parameters('neuResourceGroup')]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
            {
              "name": "sql-server-neu-deployment",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-sql.json')]"
                },
                "parameters": {
                  "sqlAdministratorLogin": {
                    "value": "[parameters('sqlAdministratorLogin')]"
                  },
                  "sqlAdministratorLoginPassword": {
                    "value": "[parameters('sqlAdministratorLoginPassword')]"
                  },
                  "sqlserverName": {
                    "value": "[parameters('neuSqlServerName')]"
                  },
                  "elasticPoolName": {
                    "value": "[parameters('elasticPoolName')]"
                  },
                  "CHGWIP": {
                    "value": "[parameters('CHGWIP')]"
                  },
                  "elasticPoolSku": {
                    "value": "[parameters('elasticPoolSku')]"
                  },
                  "elasticPoolProperties": {
                    "value": "[parameters('elasticPoolProperties')]"
                  },
                  "azureActiveDirectoryAdmin": {
                    "value": "[parameters('azureActiveDirectoryAdmin')]"
                  },
                  "azureActiveDirectoryAdminSID": {
                    "value": "[parameters('azureActiveDirectoryAdminSID')]"
                  }
               }
              }
            }
          ]
        }
      }
    },
    {
      "apiVersion": "2020-10-01",
      "name": "[concat('sql-server-firewall-rule-neu','-',parameters('sqlFireWallRules')[copyIndex()].Name)]",
      "type": "Microsoft.Resources/deployments",
      "resourceGroup": "[parameters('neuResourceGroup')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/sql-server-firewall-rules.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "serverName": {
            "value": "[parameters('neuSqlServerName')]"
          },
          "subnetResourceIdList": {
            "value": "[createArray()]"
          },
          "copyMode": {
            "value": "[parameters('sqlFirewallRulesCopyMode')]"
          },
          "ipAddresses": {
            "value": ["[parameters('sqlFireWallRules')[copyIndex()].IPRange]"]
          },
          "firewallRuleNamePrefix": {
            "value": "[parameters('sqlFireWallRules')[copyIndex()].DisplayName]"
          }
        }
      },
      "copy": {
        "name": "ipaddresscopy",
        "count": "[length(parameters('sqlFireWallRules'))]",
        "mode": "Parallel"
      },   
      "dependsOn": [
        "[resourceId(parameters('neuResourceGroup'),'Microsoft.Resources/deployments', 'neu-Resources-deployment')]"
      ]
    },
    {
      "condition": "[parameters('provisionSQLGeoReplication')]",
      "apiVersion": "2020-10-01",
      "name": "sql-server-failover-group",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/sql-server-failover-groups.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "sqlserverName": {
            "value": "[parameters('sqlServerName')]"
          },
          "neuSqlServerId": {
            "value": "[resourceId(parameters('neuResourceGroup'),'Microsoft.Sql/servers', parameters('neuSqlServerName'))]"
          },
          "databaseNames": {
            "value": "[variables('listOfDatabaseNames')]"
        
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sql-server')]",
        "[resourceId(parameters('neuResourceGroup'),'Microsoft.Resources/deployments', 'neu-Resources-deployment')]"
        
      ]
    },
    {
      "condition": "[parameters('deployVirtualNetwork')]",
      "apiVersion": "2020-10-01",
      "name": "sql-server-firewall-rule",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/sql-server-firewall-rules.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "serverName": {
            "value": "[parameters('sqlServerName')]"
          },
          "subnetResourceIdList": {
            "value": "[if(parameters('deployVirtualNetwork'), reference('get-subnet-resourceid-list', '2020-10-01').outputs.subnetResourceIdList.value, variables('emptyArray'))]"
          },
          "copyMode": {
            "value": "[parameters('sqlFirewallRulesCopyMode')]"
          },
          "ipAddresses": {
            "value": "[parameters('LogicAppConnectionIpRulesSql')]"
          },
          "firewallRuleNamePrefix": {
            "value": "logicAppConnections"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sql-server')]"
      ]
    },
    {
      "condition": "[not(empty(parameters('databaseNames')))]",
      "name": "[if(empty(parameters('databaseNames')),'no-databases-to-deploy',parameters('databaseNames')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/database.json')]"
        },
        "parameters": {
          "databaseName": {
            "value": "[parameters('databaseNames')[copyIndex()].name]"
          },
          "transparentDataEncryption": {
            "value": "[parameters('transparentDataEncryption')]"
          },
          "sqlServerName": {
            "value": "[parameters('sqlServerName')]"
          },
          "elasticPoolName": {
            "value": "[parameters('elasticPoolName')]"
          },
          "databaseMaxSizeBytes": {
            "value": "[parameters('databaseNames')[copyIndex()].maxSizeBytes]"
          },
          "databaseSku": {
            "value": "[if(contains(parameters('databaseNames')[copyIndex()], 'sku'), parameters('databaseNames')[copyIndex()].sku, variables('elasticSku'))]"
          }
        }
      },
      "copy": {
        "name": "databasecopy",
        "count": "[length(parameters('databaseNames'))]",
        "mode": "Parallel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sql-server')]"
      ]
    },
    {
      "name": "app-insights",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-insights.json')]"
        },
        "parameters": {
          "appInsightsName": {
            "value": "[parameters('appInsightsName')]"
          },
          "WorkspaceResourceId": {
            "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceId'))]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-workspace')]"
      ]
    },
    {
      "apiVersion": "2020-10-01",
      "name": "add-appInsights-instrumentation-key-vault-secret",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "appInsightsInstrumentationKey"
          },
          "secretValue": {
            "value": "[reference('app-insights').outputs.InstrumentationKey.value]"
          },
          "contentType": {
            "value": "AppInsights instrumentation key"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights')]"
      ]
    },
    {
      "condition": "[parameters('deployDataFactory')]",
      "name": "azure-datafactory",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-data-factory.json')]"
        },
        "parameters": {
          "azureDataFactoryName": {
            "value": "[parameters('azureDataFactoryName')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "name": "storage-account",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/storage-account.json')]"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "NetFirewall":{
              "value": true
          },
          "ipRules": {
            "value": "[parameters('cdnIpRules')]"
          },
          "virtualNetworksSubNet": {
            "value": []
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'virtual-network')]"
      ]
    },
    {
      "condition": "[parameters('deployAzureSearch')]",
      "name": "azure-search",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-search.json')]"
        },
        "parameters": {
          "azureSearchName": {
            "value": "[parameters('azureSearchName')]"
          }
        }
      }
    },
    {
      "condition": "[parameters('deployAzureSearchPrivateEndpoint')]",
      "apiVersion": "2020-10-01",
      "name": "azure-search-private-endpoint",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-search-private-endpoint.json')]"
        },
        "parameters": {
          "templatesBaseUri": {
            "value": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=')]"
          },
          "privateEndpointName": {
            "value": "[variables('azureSearchPrivateEndpoint').privateEndpointName]"
          },
          "privateLinkResource": {
            "value": "[variables('azureSearchPrivateEndpoint').privateLinkResource]"
          },
          "privateEndpointSubnetId": {
            "value": "[variables('azureSearchPrivateEndpoint').privateEndpointSubnetId]"
          },
          "privateDnsZoneName": {
            "value": "[variables('azureSearchPrivateEndpoint').privateDnsZoneName]"
          },
          "virtualNetworkId": {
            "value": "[variables('azureSearchPrivateEndpoint').virtualNetworkId]"
          },
          "azureSearchName": {
            "value": "[parameters('azureSearchName')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'virtual-network')]",
        "[resourceId('Microsoft.Resources/deployments', 'azure-search')]"
      ]
    },
    {
      "name": "azure-cdn",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-cdn.json')]"
        },
        "parameters": {
          "cdnProfileName": {
            "value": "[parameters('azureCdnName')]"
          },
          "azureCdnSku": {
            "value": "[parameters('azureCdnSku')]"
          }
        }
      }
    },
    {
      "name": "azure-cdn-endpoint",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/azure-cdn-endpoint.json')]"
        },
        "parameters": {
          "cdnEndpointName": {
            "value": "[parameters('cdnEndpointName')]"
          },
          "cdnProfileName": {
            "value": "[parameters('azureCdnName')]"
          },
          "originName": {
            "value": "[parameters('originName')]"
          },
          "originHostname": {
            "value": "[parameters('originHostname')]"
          },
          "customDomainName": {
            "value": "[parameters('customDomainName')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'storage-account')]",
        "[resourceId('Microsoft.Resources/deployments', 'azure-cdn')]"
      ]
    },
    {
      "condition": "[parameters('deployVirtualNetwork')]",
      "apiVersion": "2020-10-01",
      "name": "virtual-network",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/network.template.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "templatesBaseUri": {
            "value": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=')]"
          },
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "destructiveVirtualNetworkDeploy": {
            "value": "[parameters('destructiveVirtualNetworkDeploy')]"
          },
          "redisSubnet": {
            "value": "[array(variables('redisSubnetName'))]"
          },
          "azureSearchSubnet": {
            "value": "[array(variables('azureSearchSubnetName'))]"
          },
          "amplsSubnet": {
            "value": "[array(variables('amplsSubnetName'))]"
          },
          "applicationSubnets": {
            "value": "[parameters('applicationSubnets')]"
          },
          "serviceEndpointList": {
            "value": "[parameters('serviceEndpointList')]"
          }
        }
      }
    },
    {
      "condition": "[parameters('deployVirtualNetwork')]",
      "apiVersion": "2020-10-01",
      "name": "get-subnet-resourceid-list",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/getSubnetResourceIdList.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "subnetConfiguration": {
            "value": "[if(parameters('deployVirtualNetwork'), reference('virtual-network').outputs.applicationSubnetConfiguration.value, variables('emptyArray'))]"
          }
        }
      }
    },
    {
      "condition": "[parameters('deployServiceBus')]",
      "apiVersion": "2020-10-01",
      "name": "service-bus",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/service-bus.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "serviceBusNamespaceName": {
            "value": "[parameters('serviceBusNamespaceName')]"
          },
          "serviceBusSku": {
            "value": "[parameters('serviceBusSku')]"
          }
        }
      }
    },
    {
      "condition": "[parameters('deployServiceBus')]",
      "name": "delay-service-bus-key-vault-secret",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments','service-bus')]"
      ],
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "sharedServiceBusConnectionString"
          },
          "secretResourceId": {
            "value": "[resourceId('Microsoft.ServiceBus/namespaces/authorizationRules', parameters('serviceBusNamespaceName'), 'RootManageSharedAccessKey')]"
          },
          "contentType": {
            "value": "Shared service bus connection string"
          },
          "templateUri": {
            "value": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "secretResourceId": {
              "type": "string"
            },
            "contentType": {
              "type": "string"
            },
            "templateUri": {
              "type": "string"
            }
          },
          "variables": {},
          "resources": [
            {
              "apiVersion": "2020-10-01",
              "name": "add-service-bus-key-vault-secret",
              "type": "Microsoft.Resources/deployments",
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "uri": "[parameters('templateUri')]",
                  "contentVersion": "1.0.0.0"
                },
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "[parameters('secretName')]"
                  },
                  "secretValue": {
                    "value": "[listkeys(parameters('secretResourceId'), '2017-04-01').primaryConnectionString]"
                  },
                  "contentType": {
                    "value": "[parameters('contentType')]"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "condition": "[and(parameters('deployVirtualNetwork'), parameters('deployServiceBus'))]",
      "apiVersion": "2020-10-01",
      "name": "service-bus-firewall-rule",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/service-bus-network-rules.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "serviceBusNamespaceName": {
            "value": "[parameters('serviceBusNamespaceName')]"
          },
          "subnetResourceIdList": {
            "value": "[if(parameters('deployVirtualNetwork'), union(reference('get-subnet-resourceid-list', '2020-10-01').outputs.subnetResourceIdList.value,variables('pireanVnetSubnets')), variables('emptyArray'))]"
          },
          "ipAddresses": {
            "value": "[parameters('LogicAppConnectionIpRulesServiceBus')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'service-bus')]"
      ]
    },
    
    {
      "condition": "[parameters('deployASP')]",
      "apiVersion": "2020-10-01",
      "name": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('samltierAppServicePlanSku')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-service-plan.json')]"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('samltierAppServicePlanSku')[copyIndex()].name)]"
          },
          "appServicePlanSku": {
            "value": "[parameters('samltierAppServicePlanSku')[copyIndex()].sku]"
          },
          "appServicePlanOS": {
            "value": "Linux"
          },
          "appServicePlanIsLinux": {
            "value": true
          },
          "defaultCapacity": {
            "value": "[parameters('samltierAppServicePlanSku')[copyIndex()].sku.capacity]"
          }
        }
      },
      "copy": {
        "name": "FeAspCopy",
        "count": "[length(parameters('samltierAppServicePlanSku'))]",
        "mode": "Parallel"
      }
    },
    {
      "condition": "[parameters('deployASP')]",
      "apiVersion": "2020-10-01",
      "name": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('prestierAppServicePlanSku')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-service-plan.json')]"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('prestierAppServicePlanSku')[copyIndex()].name)]"
          },
          "appServicePlanSku": {
            "value": "[parameters('prestierAppServicePlanSku')[copyIndex()].sku]"
          },
          "appServicePlanOS": {
            "value": "Linux"
          },
          "appServicePlanIsLinux": {
            "value": true
          },
          "defaultCapacity": {
            "value": "[parameters('prestierAppServicePlanSku')[copyIndex()].sku.capacity]"
          }
        }
      },
      "copy": {
        "name": "FeAspCopy",
        "count": "[length(parameters('prestierAppServicePlanSku'))]",
        "mode": "Parallel"
      }
    },
    {
      "condition": "[parameters('deployASP')]",
      "apiVersion": "2020-10-01",
      "name": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('midtierAppServicePlanSku')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-service-plan.json')]"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('midtierAppServicePlanSku')[copyIndex()].name)]"
          },
          "appServicePlanSku": {
            "value": "[parameters('midtierAppServicePlanSku')[copyIndex()].sku]"
          },
          "appServicePlanOS": {
            "value": "Linux"
          },
          "appServicePlanIsLinux": {
            "value": true
          },
          "defaultCapacity": {
            "value": "[parameters('midtierAppServicePlanSku')[copyIndex()].sku.capacity]"
          }
        }
      },
      "copy": {
        "name": "FeAspCopy",
        "count": "[length(parameters('midtierAppServicePlanSku'))]",
        "mode": "Parallel"
      }
    },
    {
      "condition": "[parameters('deployASP')]",
      "apiVersion": "2020-10-01",
      "name": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('backEndAppServicePlanSku')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-service-plan.json')]"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('backEndAppServicePlanSku')[copyIndex()].name)]"
          },
          "appServicePlanSku": {
            "value": "[parameters('backEndAppServicePlanSku')[copyIndex()].sku]"
          },
          "appServicePlanOS": {
            "value": "Linux"
          },
          "appServicePlanIsLinux": {
            "value": true
          },
          "defaultCapacity": {
            "value": "[parameters('backEndAppServicePlanSku')[copyIndex()].sku.capacity]"
          }

        }
      },
      "copy": {
        "name": "FeAspCopy",
        "count": "[length(parameters('backEndAppServicePlanSku'))]",
        "mode": "Parallel"
      }
    },
    {
      "condition": "[and(equals(parameters('environmentId'), 'd01'),parameters('deployASP'))]",
      "apiVersion": "2020-10-01",
      "name": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('utilsAppServicePlanSku')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-service-plan.json')]"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('utilsAppServicePlanSku')[copyIndex()].name)]"
          },
          "appServicePlanSku": {
            "value": "[parameters('utilsAppServicePlanSku')[copyIndex()].sku]"
          },
          "appServicePlanOS": {
            "value": "Linux"
          },
          "appServicePlanIsLinux": {
            "value": true
          },
          "defaultCapacity": {
            "value": "[parameters('utilsAppServicePlanSku')[copyIndex()].sku.capacity]"
          }
        }
      },
      "copy": {
        "name": "FeAspCopy",
        "count": "[length(parameters('utilsAppServicePlanSku'))]",
        "mode": "Parallel"
      }
    },
    {
      "condition": "[and(not(equals(parameters('environmentId'), 't03')),not(parameters('deployASP')))]",
      "apiVersion": "2020-10-01",
      "name": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('pireanAppServicePlanSku')[copyIndex()].name)]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/app-service-plan.json')]"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[concat(parameters('platformGlobalIdentifier'),parameters('environmentId'),'-',parameters('pireanAppServicePlanSku')[copyIndex()].name)]"
          },
          "appServicePlanSku": {
            "value": "[parameters('pireanAppServicePlanSku')[copyIndex()].sku]"
          },
          "appServicePlanOS": {
            "value": "Linux"
          },
          "appServicePlanIsLinux": {
            "value": true
          },
          "defaultCapacity": {
            "value": "[parameters('pireanAppServicePlanSku')[copyIndex()].sku.capacity]"
          }
        }
      },
      "copy": {
        "name": "FeAspCopy",
        "count": "[length(parameters('pireanAppServicePlanSku'))]",
        "mode": "Parallel"
      }
    },
    {
      "condition": "[not(empty(parameters('databaseNames')))]",
      "name": "[if(empty(parameters('databaseNames')),'no-databases-to-add-in-keyvault',parameters('databaseNames')[copyIndex()].secretName)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "[parameters('databaseNames')[copyIndex()].secretName]"
          },
          "secretValue": {
            "value": "[parameters('databaseNames')[copyIndex()].name]"
          },
          "contentType": {
            "value": ""
          }
        }
      },
      "copy": {
        "name": "databasecopy",
        "count": "[length(parameters('databaseNames'))]",
        "mode": "Parallel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sql-server')]"
      ]
    },
    {
      "apiVersion": "2020-10-01",
      "name": "add-sql-server-name-key-vault-secret",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "platformGlobalServerName"
          },
          "secretValue": {
            "value": "[concat(parameters('sqlServerName'),'.database.windows.net')]"
          },
          "contentType": {
            "value": ""
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sql-server')]"
      ]
    },
    {
      "condition": "[not(empty(parameters('TopicNames')))]",
      "name": "[if(empty(parameters('TopicNames')),'no-topics-to-deploy', concat(parameters('serviceBusNamespaceName'), '/', parameters('TopicNames')[copyIndex()].name))]",
      "type": "Microsoft.ServiceBus/namespaces/topics",
      "apiVersion": "2022-01-01-preview",
      "properties": {
        "properties": {
          "maxMessageSizeInKilobytes": 1024,
          "defaultMessageTimeToLive": "P10675199DT2H48M5.4775807S",
          "maxSizeInMegabytes": 1024,
          "requiresDuplicateDetection": false,
          "duplicateDetectionHistoryTimeWindow": "PT10M",
          "enableBatchedOperations": true,
          "status": "Active",
          "supportOrdering": true,
          "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
          "enablePartitioning": false,
          "enableExpress": false
      }
      },
      "copy": {
        "name": "TopicNames",
        "count": "[length(parameters('TopicNames'))]",
        "mode": "Parallel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'service-bus')]"
      ]
    },
    {
      "condition": "[not(empty(parameters('TopicNames')))]",
      "name": "[if(empty(parameters('TopicNames')),'no-subscriptions-to-deploy', concat(parameters('serviceBusNamespaceName'), '/', parameters('TopicNames')[copyIndex()].name, '/', parameters('TopicNames')[copyIndex()].subscription))]",
      "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
      "apiVersion": "2022-01-01-preview",
      "properties": {
        "properties": {
          "isClientAffine": false,
          "lockDuration": "PT2M",
          "requiresSession": false,
          "defaultMessageTimeToLive": "P10675199DT2H48M5.4775807S",
          "deadLetteringOnMessageExpiration": false,
          "deadLetteringOnFilterEvaluationExceptions": true,
          "maxDeliveryCount": 10,
          "status": "Active",
          "enableBatchedOperations": true,
          "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S"
      }
      },
      "copy": {
        "name": "TopicNames",
        "count": "[length(parameters('TopicNames'))]",
        "mode": "Parallel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'service-bus')]",
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), 'audit')]",
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), 'securealert')]"
      ]
    },
    {
      "condition": "[not(empty(parameters('TopicNames')))]",
      "name": "[if(empty(parameters('TopicNames')),'no-TopicNames-to-add-in-keyvault', parameters('TopicNames')[copyIndex()].secretNameTopic)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "[parameters('TopicNames')[copyIndex()].secretNameTopic]"
          },
          "secretValue": {
            "value": "[parameters('TopicNames')[copyIndex()].name]"
          },
          "contentType": {
            "value": ""
          }
        }
      },
      "copy": {
        "name": "topicscopy",
        "count": "[length(parameters('TopicNames'))]",
        "mode": "Parallel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'service-bus')]",
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), 'audit')]",
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), 'securealert')]"
      ]
    },
    {
      "condition": "[not(empty(parameters('TopicNames')))]",
      "name": "[if(empty(parameters('TopicNames')),'no-Subscriptions-to-add-in-keyvault', parameters('TopicNames')[copyIndex()].secretNameSubscription)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "[parameters('TopicNames')[copyIndex()].secretNameSubscription]"
          },
          "secretValue": {
            "value": "[parameters('TopicNames')[copyIndex()].subscription]"
          },
          "contentType": {
            "value": ""
          }
        }
      },
      "copy": {
        "name": "subscriptionscopy",
        "count": "[length(parameters('TopicNames'))]",
        "mode": "Parallel"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'service-bus')]",
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), 'audit')]",
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusNamespaceName'), 'securealert')]"
      ]
    },
    {
      "apiVersion": "2020-10-01",
      "name": "add-Search-Name-key-vault-secret",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "azureSearchName"
          },
          "secretValue": {
            "value": "[parameters('azureSearchName')]"
          },
          "contentType": {
            "value": ""
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'azure-search')]"
      ]
    },
    {
      "apiVersion": "2020-10-01",
      "name": "add-Search-Apikey-key-vault-secret",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('templatesBaseUri'),'&repo=DFE-Digital/login.dfe.devops&ref=',parameters('branch'),'&token=', parameters('AccessToken'),'&file=templates/key-vault-secret.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "secretName": {
            "value": "azureSearchkey"
          },
          "secretValue": {
            "value": "[reference('azure-search', '2020-10-01').outputs.azureSearchKey.value]"
          },
          "contentType": {
            "value": ""
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'azure-search')]"
      ]
    }
  ],
  "outputs": {}
}